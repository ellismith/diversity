# Cell Type Diversity Analysis

Analysis pipeline for calculating and visualizing alpha and beta diversity of cell types and subtypes across brain regions in aging primates.

## Overview

This pipeline computes diversity metrics at two levels:
1. **Cell type level**: Diversity of major cell types within each brain region
2. **Subtype level**: Diversity of subtypes within each cell type (e.g., GABAergic neuron subtypes)

## Key Metrics

### Alpha Diversity (within-individual variation)
- **Adjusted Entropy**: Normalized Shannon entropy, range [-1, 0] where 0 = maximum diversity, -1 = minimum diversity (single type)
- **Shannon Diversity**: Standard Shannon entropy, higher values = more diversity

### Beta Diversity (between-individual variation)
- **Mean Bray-Curtis Distance**: Average dissimilarity between an individual and all others
- **Min Bray-Curtis Distance (Uniqueness)**: Distance to nearest neighbor, measures how divergent an individual is from the most similar individual

## Important Data Handling Notes

### Cell Count Filtering (`calc_diversity.py`)
The pipeline supports filtering animals based on minimum cell counts:
- Use `--min_cells` argument in `calc_diversity.py` to exclude animals with fewer than N cells of that cell type
- Default is 0 (no filtering) → saves to `diversity_min0/`
- `--min_cells 100` → saves to `diversity_min100/` directory
- This addresses data quality issues where some animals have very sparse coverage in certain regions/cell types

### Missing Data vs. Low Diversity
The pipeline distinguishes between two cases:
1. **Missing data**: Animal has NO cells for a specific region/celltype combination → EXCLUDED from analysis
2. **Low diversity**: Animal has cells but only 1 subtype → INCLUDED with diversity = -1.0 (adjusted) or 0.0 (Shannon)

### Shannon Diversity Special Case
- When an animal has only 1 subtype, Shannon diversity may be stored as NaN in the CSV
- Plotting scripts (`plot_alpha_regression.py`, etc.) replace NaN with 0.0 for animals with cells
- If the animal has NO cells, they are excluded entirely

### Regional Variation in Coverage
Different regions have vastly different coverage for certain cell types:
- **Good coverage** (most animals ≥100 cells): HIP, dlPFC, ACC, EC glutamatergic neurons; most astrocytes/oligodendrocytes
- **Poor coverage** (most animals <100 cells): CN and NAc glutamatergic neurons; IPP astrocytes/microglia/OPCs
- See `diversity_min0/cell_count_summary_by_region_celltype.csv` (generated by `analyze_cell_count_distributions.py`) for detailed statistics

## Directory Structure
```
diversity_min0/                 # Original data (no filtering, min_cells=0)
diversity_min100/               # Filtered data (min_cells=100)
diversity_figs_min0/            # Plots for original data
  ├── {region}/                 # Region-specific plots
  └── cross_region_analysis/    # Cross-region heatmaps
diversity_figs_min100/          # Plots for filtered data
  ├── {region}/                 # Region-specific plots
  ├── age_effect_heatmaps/      # Cross-region heatmaps
  └── exclusion_summary.csv     # Animals excluded by filtering
scripts/                        # Core analysis scripts
```

## Core Analysis Scripts

### 1. Calculate Diversity (`scripts/calc_diversity.py`)

Calculate alpha and beta diversity metrics with optional cell count filtering.
```bash
# Cell type level (no filtering)
./calc_diversity.py --region HIP --level celltype

# Subtype level (no filtering)
./calc_diversity.py --region HIP --level subtype --celltype "GABAergic neurons"

# With cell count filtering
./calc_diversity.py --region HIP --level subtype --celltype "microglia" --min_cells 100
```

**Key Arguments:**
- `--region`: Brain region (ACC, CN, dlPFC, EC, HIP, IPP, lCb, M1, MB, mdTN, NAc)
- `--level`: celltype or subtype
- `--celltype`: Required for subtype level
- `--min_cells`: Minimum cells required per animal (default: 0)
- `--out_dir`: Output directory (auto-set based on min_cells if not specified)

**Outputs:**
- `{prefix}_alpha_diversity_adjusted.csv` - Adjusted entropy values
- `{prefix}_alpha_diversity_shannon.csv` - Shannon diversity values
- `{prefix}_beta_diversity.csv` - Pairwise Bray-Curtis distance matrix
- `{prefix}_metadata.csv` - Animal age information

### 2. Create Minimum Beta Diversity (`create_min_beta_csvs.py`)

Generate minimum beta diversity (uniqueness) metrics from pairwise distance matrices.
```bash
# For original data
./create_min_beta_csvs.py --data_dir diversity_min0

# For filtered data
./create_min_beta_csvs.py --data_dir diversity_min100
```

**Outputs:**
- `{prefix}_min_beta_diversity.csv` - Minimum distance to nearest neighbor for each animal

### 3. Test Age Effects (`test_age_diversity.py`)

Calculate correlations between age and diversity metrics.
```bash
# Original data
./test_age_diversity.py --region HIP --level celltype --data_dir diversity_min0

# Filtered data
./test_age_diversity.py --region HIP --level subtype --data_dir diversity_min100
```

**Outputs:**
- `{region}_{level}_age_effects_adjusted.csv` - Age correlations for adjusted entropy
- `{region}_{level}_age_effects_shannon.csv` - Age correlations for Shannon diversity
- `{region}_{level}_age_effects_min_beta.csv` - Age correlations for min beta diversity

## Visualization Scripts

### Individual Regression Plots

Generate scatter plots with regression lines for age effects:
```bash
# Alpha diversity (adjusted entropy)
./plot_alpha_regression.py --region HIP --celltype "microglia" \
    --data_dir diversity_min100 --output_dir diversity_figs_min100

# Beta diversity (mean)
./plot_beta_mean_regression.py --region HIP --celltype "microglia" \
    --data_dir diversity_min100 --output_dir diversity_figs_min100

# Beta diversity (min/uniqueness)
./plot_beta_min_regression.py --region HIP --celltype "microglia" \
    --data_dir diversity_min100 --output_dir diversity_figs_min100
```

### Four-Panel Forest Plots (`replot_all_four_panel_summaries_final.py`)

Generate comprehensive summary plots showing all four metrics:
```bash
./replot_all_four_panel_summaries_final.py \
    --data_dir diversity_min100 --output_dir diversity_figs_min100
```

Creates plots with:
- Adjusted Entropy ~ Age
- Shannon Diversity ~ Age
- Beta Diversity (Mean) ~ Age
- Beta Diversity (Min) ~ Age

### Cross-Region Age Effect Heatmaps

Compare age effects across regions and cell types:
```bash
# For original data (plot_age_effect_heatmaps.py)
python3 plot_age_effect_heatmaps.py

# For filtered data (plot_age_effect_heatmaps_min100.py)
python3 plot_age_effect_heatmaps_min100.py
```

Creates heatmaps (rows=cell types, columns=regions) showing:
- Correlation coefficients (r values)
- Significance stars (*, **, ***)
- Sample sizes (n=)

### Mean vs Min Beta Analysis (`remake_mean_vs_min_analysis.py`)

Compare mean beta diversity with min beta diversity (uniqueness):
```bash
python3 remake_mean_vs_min_analysis.py
```

Creates 6-panel plots for selected cell types showing:
- Mean vs Min Beta correlation
- Distribution of pairwise distances
- Mean Beta vs Age
- MDS ordination
- Distance to 2nd nearest neighbor
- Min Beta vs Age

### Exclusion Analysis (`summarize_exclusions_min100.py`)

Summarize which animals were excluded by min_cells filter:
```bash
python3 summarize_exclusions_min100.py
```

Creates:
- `exclusion_summary.csv` - Detailed exclusion records
- Heatmap of exclusions by region/celltype
- Cell count distributions for excluded animals
- Most frequently excluded animals

### Cell Count Distribution Analysis (`analyze_cell_count_distributions.py`)

Analyze cell count distributions to determine appropriate filtering thresholds:
```bash
python3 analyze_cell_count_distributions.py
```

Creates:
- `cell_count_summary_by_region_celltype.csv` - Statistics for all region/celltype combinations
- Heatmaps showing median counts and % animals below threshold
- Distribution plots by cell type

## Batch Processing Scripts

### Run All Diversity Calculations
```bash
# No filtering (run_all_regions.sh)
cd scripts
./run_all_regions.sh

# With min_cells=100 filtering (run_all_calc_diversity_min100.sh)
./run_all_calc_diversity_min100.sh

# Or submit to cluster (run_all_diversity_min100_slurm.sh)
sbatch run_all_diversity_min100_slurm.sh
```

### Run All Plotting
```bash
# For filtered data (run_all_plotting_min100.sh)
./run_all_plotting_min100.sh

# Individual regression plots (plot_all_regressions_min100.sh)
./plot_all_regressions_min100.sh
```

## Typical Workflow

### 1. Calculate diversity metrics
```bash
cd scripts

# Run for all regions with min_cells=100
./run_all_calc_diversity_min100.sh
```

### 2. Generate minimum beta diversity
```bash
cd ..
python3 create_min_beta_csvs.py --data_dir diversity_min100
```

### 3. Test age effects
```bash
for region in ACC CN dlPFC EC HIP IPP lCb M1 MB mdTN NAc; do
    python3 test_age_diversity.py --data_dir diversity_min100 --region ${region} --level celltype
    python3 test_age_diversity.py --data_dir diversity_min100 --region ${region} --level subtype
done
```

### 4. Create visualizations
```bash
# All regression plots
./plot_all_regressions_min100.sh

# Four-panel summaries
python3 replot_all_four_panel_summaries_final.py \
    --data_dir diversity_min100 --output_dir diversity_figs_min100

# Cross-region heatmaps
python3 plot_age_effect_heatmaps_min100.py

# Exclusion analysis
python3 summarize_exclusions_min100.py
```

## Key Considerations

### Statistical Testing
- P-values from linear regressions are **uncorrected** for multiple comparisons
- Consider applying FDR correction (Benjamini-Hochberg) when reporting results
- Red bars in forest plots indicate p < 0.05 (nominal significance)

### Data Filtering Best Practices
When creating plots, plotting scripts automatically filter to animals with cells:
```python
# Example from plot_alpha_regression.py
animals_with_cells = get_animals_with_cells(region, celltype)
alpha_df = alpha_df[alpha_df.index.isin(animals_with_cells)]

# Handle Shannon NaN for one-subtype cases
if metric == 'shannon_diversity':
    alpha_df[metric] = alpha_df[metric].fillna(0.0)
```

### Interpreting Metrics
- **Negative age correlation for alpha**: Diversity decreases with age (cells become more uniform)
- **Positive age correlation for mean beta**: Individuals become more different from each other with age
- **Positive age correlation for min beta**: Individuals become more unique (diverge from nearest neighbor)

### Regional Differences
- Cortical regions (dlPFC, ACC, M1) generally have good coverage for most cell types
- Subcortical regions (CN, NAc) have very sparse glutamatergic neurons
- IPP has variable coverage depending on sample quality
- MB lacks GABAergic neurons (not expected in midbrain)
- Run `analyze_cell_count_distributions.py` for detailed statistics

## Requirements
```bash
# Core dependencies
pip install scanpy pandas numpy scipy scikit-learn matplotlib seaborn

# For running on cluster
module load anaconda3
conda activate latent_analysis
```

## Data Sources

**Input data location:**
- H5AD files: `/scratch/nsnyderm/u01/intermediate_files/regions_h5ad_update/`
- Cell type annotation column: `cell_class_annotation`
- Subtype annotation column: `subtype`
- Minimum age filter: 1.0 years (default)

## Citation

If using this pipeline, please cite:
- Original data source: [Add citation]
- Min beta/uniqueness metric based on: Wilmanski et al. 2021 Nature Metabolism

## Contact

For questions or issues: [Add contact info]
